name: Build RPM

on: push

jobs:
  test:
    name: Run Python Unit Tests
    runs-on: ubuntu-latest

    container:
      image: oraclelinux:8
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python and Pytest
        run: |
          yum install -y python3 python3-pip
          pip3 install pytest

      - name: Run tests
        run: |
          pytest src/test_pinvirt.py

  build-ol8:
    name: Build RPM on Oracle Linux 8
    runs-on: ubuntu-latest
    needs: test

    container:
      image: oraclelinux:8
      options: --privileged 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          yum install -y rpm-build rpmdevtools
          yum install -y python3
          rpmdev-setuptree

      - name: Prepare sources
        run: |
          cp src/pinvirt.py ~/rpmbuild/SOURCES/
          cp rpm/pinvirt.spec ~/rpmbuild/SPECS/

      - name: Build RPM
        run: |
          rpmbuild -ba ~/rpmbuild/SPECS/pinvirt.spec

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: pinvirt-rpm-ol8
          path: ~/rpmbuild/RPMS/noarch/
          if-no-files-found: error

  build-rockylinux9:
    name: Build RPM on Rocky Linux 9
    runs-on: ubuntu-latest
    needs: test

    container:
      image: rockylinux:9.3
      options: --privileged 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          yum install -y rpm-build rpmdevtools
          yum install -y python3
          rpmdev-setuptree

      - name: Prepare sources
        run: |
          cp src/pinvirt.py ~/rpmbuild/SOURCES/
          cp rpm/pinvirt.spec ~/rpmbuild/SPECS/

      - name: Build RPM
        run: |
          rpmbuild -ba ~/rpmbuild/SPECS/pinvirt.spec

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: pinvirt-rpm-el9
          path: ~/rpmbuild/RPMS/noarch/
          if-no-files-found: error